<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kokoro TTS Processor</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #status {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #333;
        }
        #progress {
            width: 80%;
            height: 20px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="status">Loading Kokoro TTS...</div>
    <progress id="progress" value="0" max="100"></progress>

    <script src="https://cdn.jsdelivr.net/npm/kokoro-js@1.2.0/dist/index.min.js"></script>
    <script>
        // Initialize variables
        let ttsModel = null;
        let voices = [];
        let isLoading = true;

        // Function to communicate with React Native
        function sendToReactNative(type, data) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type,
                    data
                }));
            }
        }

        // Function to initialize the TTS model
        async function initTTS() {
            try {
                const statusEl = document.getElementById('status');
                const progressEl = document.getElementById('progress');
                
                statusEl.textContent = 'Loading Kokoro TTS model...';
                
                // Initialize the model
                ttsModel = await KokoroTTS.from_pretrained(
                    "onnx-community/Kokoro-82M-v1.0-ONNX",
                    {
                        dtype: "q8",
                        device: "wasm",
                        progress_callback: (progress) => {
                            progressEl.value = progress * 100;
                            sendToReactNative('progress', { progress });
                        }
                    }
                );
                
                // Get available voices
                voices = ttsModel.list_voices();
                
                statusEl.textContent = 'TTS Model loaded successfully!';
                progressEl.classList.add('hidden');
                
                // Send voices to React Native
                sendToReactNative('loaded', { voices });
                
                isLoading = false;
            } catch (error) {
                console.error('Error initializing TTS:', error);
                document.getElementById('status').textContent = 'Error loading TTS model: ' + error.message;
                sendToReactNative('error', { message: error.message });
            }
        }

        // Function to generate speech
        async function generateSpeech(text, voice, speed) {
            if (!ttsModel) {
                sendToReactNative('error', { message: 'TTS model not loaded' });
                return;
            }
            
            try {
                // Generate audio
                const audio = await ttsModel.generate(text, {
                    voice: voice || "af_heart",
                    speed: speed || 1.0
                });
                
                // Convert audio data to base64
                const audioArray = new Uint8Array(audio.data);
                let binary = '';
                for (let i = 0; i < audioArray.length; i++) {
                    binary += String.fromCharCode(audioArray[i]);
                }
                const base64Audio = btoa(binary);
                
                // Send audio data to React Native
                sendToReactNative('audioData', { 
                    audioBase64: base64Audio,
                    sampleRate: audio.sample_rate
                });
            } catch (error) {
                console.error('Error generating speech:', error);
                sendToReactNative('error', { message: error.message });
            }
        }

        // Listen for messages from React Native
        window.addEventListener('message', function(event) {
            try {
                const message = JSON.parse(event.data);
                
                switch (message.type) {
                    case 'generateSpeech':
                        generateSpeech(message.text, message.voice, message.speed);
                        break;
                    case 'getVoices':
                        sendToReactNative('voices', { voices });
                        break;
                }
            } catch (error) {
                console.error('Error processing message:', error);
            }
        });

        // Initialize TTS when the page loads
        window.onload = initTTS;
    </script>
</body>
</html> 